:root{
      --ui-bg: #f7f8fa;
      --muted: #7b8190;
      --accent: #2563eb;
      --accent-gradient: linear-gradient(90deg,#2563eb 0%,#4f8cff 100%);
      --success: #10b981;
      --danger: #ef4444;
      --panel-bg: rgba(255,255,255,0.82);
      --panel-blur: blur(12px);
      --shadow: 0 8px 32px rgba(0,0,0,0.10), 0 1.5px 4px rgba(0,0,0,0.04);
      --radius: 18px;
      --transition: .18s cubic-bezier(.4,0,.2,1);
      --font: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    }
    html,body{
      height:100%;margin:0;
      font-family:var(--font);
      background: linear-gradient(120deg, #e0e7ff 0%, #f7f8fa 100%);
      font-size: 16px;
      color: #23272f;
      transition: background .4s;
    }
    #app{display:grid;grid-template-rows:auto 1fr;height:100%}
    header{
      display:flex;align-items:center;gap:12px;
      padding:14px 24px 10px 24px;
      border-bottom:1px solid #e5e7eb;
      position:sticky;top:0;background:var(--ui-bg);z-index:1400;height:60px;
      box-shadow:0 2px 12px rgba(0,0,0,0.04);
      backdrop-filter: blur(8px);
      transition: background var(--transition), box-shadow var(--transition);
    }
    header h1{
      font-size:20px;margin:0;font-weight:700;letter-spacing:-.5px;
      color:var(--accent);
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .spacer{flex:1}
    #map{width:100%;height:100%}

    .icon-btn{
      display:inline-flex;align-items:center;gap:8px;
      border:none;background:transparent;
      padding:8px 10px;border-radius:12px;cursor:pointer;
      transition: background var(--transition), box-shadow var(--transition), transform .12s;
      box-shadow: none;
    }
    .icon-btn img{width:22px;height:22px;display:block}
    .icon-btn:hover{
      background:rgba(37,99,235,0.08);
      box-shadow:0 2px 8px rgba(37,99,235,0.08);
      transform: translateY(-1px) scale(1.04);
    }
    .icon-btn:active{transform:scale(.97);}

    .search-wrap{
      display:flex;gap:10px;align-items:center;margin-left:8px;
      background:rgba(255,255,255,0.7);
      border-radius:14px;
      box-shadow:0 2px 8px rgba(37,99,235,0.06);
      padding:2px 8px;
      backdrop-filter: blur(8px);
    }
    #searchInput{
      width:320px;max-width:40vw;
      padding:10px 14px;
      border-radius:12px;
      border:1.5px solid #e0e7ef;
      font-size:15px;
      background:rgba(255,255,255,0.88);
      transition: border var(--transition), box-shadow var(--transition);
      box-shadow:0 1.5px 6px rgba(37,99,235,0.04);
    }
    #searchInput:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 2px 8px rgba(37,99,235,0.10);
    }
    #searchBtn{
      padding:10px 18px;
      border-radius:12px;
      border:none;
      background:var(--accent-gradient);
      color:#fff;
      font-weight:600;
      font-size:15px;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(37,99,235,0.10);
      transition: background var(--transition), box-shadow var(--transition), transform .12s;
    }
    #searchBtn:hover{background:linear-gradient(90deg,#1d4ed8 0%,#60a5fa 100%);transform:translateY(-1px) scale(1.04);}
    #searchBtn:active{transform:scale(.97);}
    #searchResults{
      position:absolute;top:72px;left:24px;
      width:380px;max-width:calc(100% - 48px);
      background:rgba(255,255,255,0.98);
      border:1.5px solid #e0e7ef;
      border-radius:16px;
      box-shadow:0 12px 32px rgba(37,99,235,0.10);
      z-index:1500;display:none;max-height:340px;overflow:auto;
      animation: fadeIn .22s;
      backdrop-filter: blur(10px);
    }
    .search-item{
      padding:12px 16px;
      border-bottom:1px solid #f2f4fa;
      cursor:pointer;
      transition: background var(--transition);
      font-size:15px;
    }
    .search-item:hover{background:rgba(37,99,235,0.07);}

    .panel{
      position:absolute;top:96px;left:24px;
      width:340px;max-width:calc(100% - 48px);
      background:var(--panel-bg);
      border:1.5px solid #e0e7ef;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      z-index:1350;overflow:hidden;display:none;
      backdrop-filter: var(--panel-blur);
      animation: fadeIn .22s;
      transition: box-shadow var(--transition), background var(--transition);
    }
    .panel header{
      border-bottom:1.5px solid #f0f2f7;
      padding:14px 18px 10px 18px;
      background:transparent;
      font-size:16px;
      font-weight:700;
      color:var(--accent);
      letter-spacing:-.2px;
    }
    .content{padding:18px;display:grid;gap:14px}
    input,textarea,select{
      width:100%;padding:10px 14px;
      border-radius:12px;
      border:1.5px solid #e0e7ef;
      font-size:15px;
      background:rgba(255,255,255,0.93);
      transition: border var(--transition), box-shadow var(--transition);
      box-shadow:0 1.5px 6px rgba(37,99,235,0.03);
    }
    input:focus,textarea:focus,select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 2px 8px rgba(37,99,235,0.10);
    }
    textarea{min-height:72px}
    .actions{display:flex;gap:10px}
    button{cursor:pointer}
    .btn{
      border:none;
      border-radius:12px;
      padding:10px 18px;
      font-size:15px;
      font-weight:600;
      transition: background var(--transition), box-shadow var(--transition), transform .12s;
      box-shadow:0 1.5px 6px rgba(37,99,235,0.04);
    }
    .btn-primary{
      background:var(--accent-gradient);
      color:#fff;
    }
    .btn-primary:hover{background:linear-gradient(90deg,#1d4ed8 0%,#60a5fa 100%);}
    .btn-secondary{
      background:#6b7280;
      color:#fff;
    }
    .btn-secondary:hover{background:#374151;}
    .btn-ghost{
      background:rgba(37,99,235,0.07);
      color:var(--accent);
    }
    .btn-ghost:hover{background:rgba(37,99,235,0.13);}
    .hint{font-size:13px;color:var(--muted);}
    .legend{
      position:absolute;bottom:24px;right:24px;
      background:rgba(255,255,255,0.92);
      border:1.5px solid #e0e7ef;
      border-radius:14px;
      padding:14px 18px;
      font-size:14px;
      z-index:900;
      box-shadow:0 2px 12px rgba(37,99,235,0.08);
      backdrop-filter: blur(8px);
      animation: fadeIn .22s;
    }
    .legend .bar{
      height:12px;width:200px;
      background:linear-gradient(90deg,#ffff00 0%,#ff0000 100%);
      border-radius:8px;margin-top:8px;
      box-shadow:0 1.5px 6px rgba(37,99,235,0.04);
    }
    .radius-row{display:flex;gap:10px;align-items:center}
    .range{flex:1}
    .progress{
      height:10px;background:#e0e7ef;
      border-radius:8px;overflow:hidden;
      margin-bottom:4px;
    }
    .progress .fill{
      height:100%;width:0%;
      background:linear-gradient(90deg,#ffff00,#ff0000);
      transition: width .18s cubic-bezier(.4,0,.2,1);
    }
    .leaflet-top.leaflet-right .leaflet-control{z-index:1150}
    .leaflet-control-locate{
      background:rgba(255,255,255,0.92);
      padding:8px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(37,99,235,0.08);
      backdrop-filter: blur(8px);
      transition: box-shadow var(--transition);
    }
    .locate-btn{
      border:none;background:transparent;
      font-size:18px;padding:8px 10px;cursor:pointer;
      border-radius:8px;
      transition: background var(--transition);
    }
    .locate-btn img{width:20px;height:20px;display:block}
    .locate-btn:hover{background:#f0f4ff;}

    #filterBox{
      position:absolute;top:110px;right:24px;
      background:rgba(255,255,255,0.92);
      border:1.5px solid #e0e7ef;
      border-radius:14px;
      padding:12px 16px;
      z-index:1450;
      box-shadow:0 8px 24px rgba(37,99,235,0.08);
      width:auto;
      min-width:160px;
      max-width:96vw;
      transition:height var(--transition), width var(--transition), box-shadow var(--transition), background var(--transition);
      backdrop-filter: blur(8px);
      animation: fadeIn .22s;
    }
    #filterHeader{
      display:flex;align-items:center;
      font-size:14px;
      margin-bottom:10px;
    }
    #filterBody{display:block}
    #filterBox.collapsed{
      height:40px;overflow:hidden;
      width:auto;
      min-width:0;
      max-width:none;
      padding:8px 14px;
      box-shadow:0 2px 8px rgba(37,99,235,0.04);
      background:rgba(255,255,255,0.85);
      display:flex;
      align-items:center;
    }
    #filterBox.collapsed #filterBody{display:none}
    #filterToggle{
      display:none !important;
    }
    #filterTitle {
      cursor: pointer;
      user-select: none;
      transition: color 0.18s;
    }
    #filterTitle:hover {
      color: var(--accent);
    }

    /* Align checkboxes and text in filter */
    #filterBody label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      padding: 4px 0;
      cursor: pointer;
      transition: color var(--transition);
      line-height: 1.6;
    }
    #filterBody label input[type=checkbox] {
      accent-color: var(--accent);
      width: 18px;
      height: 18px;
      margin: 0 6px 0 0;
      vertical-align: middle;
      flex-shrink: 0;
      border-radius: 6px;
      border: 1.5px solid #e0e7ef;
      transition: border var(--transition);
    }

    .vote-btn{
      border-radius:10px;
      padding:8px 12px;
      border:1.5px solid #cbd5e1;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      transition: background var(--transition), color var(--transition), border var(--transition), transform .12s;
      box-shadow:0 1.5px 6px rgba(37,99,235,0.03);
    }
    .vote-btn.upvoted{
      background:var(--success);color:#fff;border-color:#059669;
      transform:scale(1.04);
    }
    .vote-btn.downvoted{
      background:var(--danger);color:#fff;border-color:#b91c1c;
      transform:scale(1.04);
    }
    .vote-btn:hover{background:rgba(37,99,235,0.07);}

    .leaflet-popup-content-wrapper{
      border-radius:18px;
      box-shadow:0 8px 32px rgba(37,99,235,0.13);
      background:rgba(255,255,255,0.97);
      backdrop-filter: blur(8px);
      border:1.5px solid #e0e7ef;
      animation: fadeIn .22s;
    }
    .leaflet-popup-content{
      font-size:15px;
      color:#23272f;
      padding:18px 12px 8px 12px;
      min-width:260px;
      max-width:420px;
    }
    .popup .badge{
      display:inline-block;
      background:var(--accent-gradient);
      color:#fff;
      border-radius:8px;
      padding:2px 10px;
      font-size:13px;
      margin-left:6px;
      font-weight:600;
      letter-spacing:.1px;
    }
    .popup button{
      font-size:14px;
      font-weight:600;
      border-radius:8px;
      padding:7px 12px;
      margin:0 2px;
      transition: background var(--transition), color var(--transition), border var(--transition);
    }
    .popup .btn-ghost{background:rgba(37,99,235,0.07);}
    .popup .btn-ghost:hover{background:rgba(37,99,235,0.13);}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(16px);}
      to{opacity:1;transform:translateY(0);}
    }

    /* 1. Map viewport & responsiveness */
    html, body, #app, #map {
      min-height: 100vh;
      height: 100vh;
      width: 100vw;
      max-width: 100vw;
      max-height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }
    #map {
      width: 100vw;
      height: 100vh;
      min-height: 100vh;
      min-width: 100vw;
      position: absolute;
      top: 0; left: 0;
      z-index: 1;
    }

    /* 2. UI elements: search bar, header, filter, legend, credit */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      width: 100vw;
      z-index: 2000;
      background: var(--ui-bg);
      display: flex;
      align-items: center;
      gap: 10px;
      height: 56px;
      min-height: 56px;
      padding: 8px 2vw 8px 2vw;
      box-sizing: border-box;
    }
    header h1 {
      font-size: 18px;
      margin: 0 8px 0 0;
      font-weight: 700;
      letter-spacing: -.5px;
      flex-shrink: 0;
    }
    .search-wrap {
      flex: 1 1 0;
      min-width: 0;
      max-width: 100vw;
      margin: 0;
      padding: 0 4px;
      background: rgba(255,255,255,0.7);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(37,99,235,0.06);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #searchInput {
      width: 100%;
      min-width: 0;
      max-width: 100vw;
      font-size: 15px;
      padding: 9px 10px;
      border-radius: 10px;
    }
    #searchBtn {
      padding: 9px 14px;
      font-size: 15px;
      border-radius: 10px;
    }
    .spacer { display: none; }

    .icon-btn, .btn {
      min-width: 44px;
      min-height: 44px;
      font-size: 16px;
      padding: 8px 10px;
      border-radius: 12px;
      margin: 0 2px;
      box-sizing: border-box;
    }
    .icon-btn img { width: 22px; height: 22px; }
    #userEmail { display: none; }

    #searchResults {
      position: fixed;
      top: 56px;
      left: 2vw;
      width: 96vw;
      max-width: 98vw;
      border-radius: 12px;
      z-index: 2100;
      font-size: 15px;
    }

    /* 3. Panel (add dangerzone) */
    .panel {
      position: fixed;
      top: 64px;
      left: 2vw;
      width: 96vw;
      max-width: 98vw;
      border-radius: 14px;
      z-index: 2100;
      padding: 0;
    }
    .panel header {
      font-size: 15px;
      padding: 12px 10px 8px 10px;
    }
    .content { padding: 12px; gap: 10px; }
    input, textarea, select {
      font-size: 15px;
      padding: 9px 10px;
      border-radius: 10px;
    }
    textarea { min-height: 56px; }
    .actions { gap: 8px; }

    /* 4. Filter box */
    #filterBox {
      position: fixed;
      top: 64px;
      right: 2vw;
      width: 54px;
      max-width: 96vw;
      border-radius: 14px;
      z-index: 2200;
      transition: width .2s, height .2s;
    }
    #filterBox:not(.collapsed) {
      width: auto;
      min-width: 160px;
      max-width: 320px;
      padding: 12px 16px;
    }
    #filterBox.collapsed {
      height: 40px;
      overflow: hidden;
      width: auto;
      min-width: 0;
      max-width: none;
      padding: 8px 14px;
      box-shadow: 0 2px 8px rgba(37,99,235,0.04);
      background: rgba(255,255,255,0.85);
      display: flex;
      align-items: center;
    }
    #filterBox.collapsed #filterBody { display: none; }
    #filterToggle {
      display: none !important;
    }
    #filterTitle {
      cursor: pointer;
      user-select: none;
      transition: color 0.18s;
    }
    #filterTitle:hover {
      color: var(--accent);
    }

    /* Align checkboxes and text in filter */
    #filterBody label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      padding: 4px 0;
      cursor: pointer;
      transition: color var(--transition);
      line-height: 1.6;
    }
    #filterBody label input[type=checkbox] {
      accent-color: var(--accent);
      width: 18px;
      height: 18px;
      margin: 0 6px 0 0;
      vertical-align: middle;
      flex-shrink: 0;
      border-radius: 6px;
      border: 1.5px solid #e0e7ef;
      transition: border var(--transition);
    }

    /* Add details floating button for mobile */
    #addDetailsBtn {
      display: none;
      position: fixed;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%);
      z-index: 3500;
      background: var(--accent-gradient);
      color: #fff;
      border: none;
      border-radius: 18px;
      font-size: 16px;
      font-weight: 600;
      padding: 13px 28px;
      box-shadow: 0 4px 24px rgba(37,99,235,0.18);
      cursor: pointer;
      opacity: 0.98;
      transition: background 0.18s, box-shadow 0.18s;
    }
    #addDetailsBtn:active {
      opacity: 0.93;
    }
    @media (max-width: 600px) {
      #addDetailsBtn {
        font-size: 15px;
        padding: 11px 22px;
        border-radius: 14px;
        bottom: 70px;
      }
      /* Add panel: smaller, more transparent, higher z-index */
      #addPanel.panel {
        width: 96vw !important;
        max-width: 99vw !important;
        left: 2vw !important;
        right: 2vw !important;
        top: 60px !important;
        border-radius: 13px !important;
        background: rgba(255,255,255,0.92) !important;
        opacity: 0.98 !important;
        box-shadow: 0 2px 12px rgba(37,99,235,0.13) !important;
        padding: 0 !important;
        z-index: 3200 !important;
      }
      #addPanel.panel header {
        font-size: 14px !important;
        padding: 8px 10px 6px 10px !important;
      }
      #addPanel .content {
        padding: 8px 10px 10px 10px !important;
        gap: 7px !important;
      }
    }

    /* 5. Legend (danger scale) - collapsible on mobile */
    .legend {
      position: fixed;
      right: 2vw;
      bottom: 16px;
      width: 90vw;
      max-width: 320px;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      z-index: 1200;
      transition: box-shadow .2s, background .2s;
    }
    .legend .bar {
      width: 100%;
      min-width: 0;
      height: 10px;
      margin-top: 6px;
    }
    .legend .hint { font-size: 12px; }
    .legend .legend-toggle {
      display: none;
    }
    @media (max-width: 600px) {
      .legend {
        width: 92vw;
        right: 4vw;
        bottom: 16px;
        padding: 8px 8px;
        font-size: 12px;
      }
      .legend .legend-toggle {
        display: block;
        background: var(--accent-gradient);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        padding: 4px 10px;
        margin-bottom: 6px;
        cursor: pointer;
        width: 36px;
        height: 32px;
        text-align: center;
      }
      .legend.collapsed .bar,
      .legend.collapsed .hint,
      .legend.collapsed div:not(.legend-toggle) {
        display: none !important;
      }
    }

    /* 6. Credit */
    .credit {
      position: fixed;
      right: 2vw;
      bottom: 72px;
      z-index: 1500;
      font-size: 13px;
      color: #888;
      background: rgba(255,255,255,0.92);
      border-radius: 10px;
      padding: 6px 14px;
      box-shadow: 0 2px 8px rgba(37,99,235,0.06);
      pointer-events: none;
      user-select: none;
    }
    @media (max-width: 600px) {
      .credit { right: 4vw; bottom: 88px; font-size: 12px; }
    }

    /* 7. Popups and touch targets */
    .leaflet-popup-content-wrapper {
      border-radius: 14px;
      font-size: 16px;
      min-width: 0;
      max-width: 95vw;
      padding: 0;
    }
    .leaflet-popup-content {
      font-size: 16px;
      padding: 14px 8px 8px 8px;
      min-width: 0;
      max-width: 95vw;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    .popup button, .vote-btn, .btn, .icon-btn {
      min-width: 44px;
      min-height: 44px;
      font-size: 16px;
      padding: 8px 10px;
      border-radius: 10px;
    }

    /* 8. Leaflet controls (zoom, locate) */
    .leaflet-top.leaflet-right .leaflet-control {
      z-index: 1200 !important;
      margin-top: 64px;
    }
    .leaflet-control-locate {
      margin-top: 12px !important;
    }
    .leaflet-control-zoom {
      margin-top: 64px !important;
    }
    .leaflet-control-zoom-in, .leaflet-control-zoom-out {
      min-width: 44px;
      min-height: 44px;
      font-size: 20px;
    }

    /* 9. Marker cluster - smaller icons for mobile */
    @media (max-width: 600px) {
      .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
        width: 32px !important;
        height: 32px !important;
        font-size: 13px !important;
      }
    }

    /* 10. General mobile UX improvements */
    @media (max-width: 900px) {
      header { height: 52px; min-height: 52px; }
      #filterBox { top: 56px; }
      .panel { top: 56px; }
    }
    @media (max-width: 600px) {
      header { height: 48px; min-height: 48px; padding: 4px 2vw; }
      #filterBox { top: 48px; }
      .panel { top: 48px; }
      #searchResults { top: 48px; }
    }
    @media (max-width: 400px) {
      header { padding: 2px 1vw; }
      .panel { left: 1vw; width: 98vw; }
      #filterBox { right: 1vw; width: 98vw; }
      .legend { right: 1vw; width: 98vw; }
      .credit { right: 1vw; }
    }

    /* 11. Touch-friendly design */
    button, .icon-btn, .btn, .vote-btn {
      touch-action: manipulation;
    }

    /* 12. Hide scrollbars on mobile for map */
    body, html {
      overflow: hidden;
    }

    body.dark-mode{
      background:linear-gradient(120deg,#232946 0%,#181c2a 100%);
      color:#e5e7ef;
    }
    body.dark-mode header,
    body.dark-mode .panel,
    body.dark-mode #filterBox,
    body.dark-mode .legend,
    body.dark-mode .search-wrap,
    body.dark-mode #searchResults,
    body.dark-mode .leaflet-popup-content-wrapper,
    body.dark-mode .mobile-search-bar,
    body.dark-mode #mobileSearchResults,
    body.dark-mode .credit {
      background:rgba(24,28,42,0.96) !important;
      color:#e5e7ef !important;
      border-color:#2d334d !important;
      box-shadow:0 8px 32px rgba(37,99,235,0.13);
    }
    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select,
    body.dark-mode #mobileSearchInput {
      background: #232946 !important;
      color: #e7e7ef !important;
      border-color: #2d334d !important;
    }
    body.dark-mode .btn-primary {
      background: linear-gradient(90deg,#3b82f6 0%,#6366f1 100%);
      color: #fff;
    }
    body.dark-mode .btn-secondary { background: #374151; }
    body.dark-mode .btn-ghost { background: rgba(99,102,241,0.10); }
    body.dark-mode .vote-btn { background: #232946; color: #e7e7ef; border-color: #2d334d; }
    body.dark-mode .vote-btn.upvoted { background: var(--success); }
    body.dark-mode .vote-btn.downvoted { background: var(--danger); }
    body.dark-mode .legend .bar { background: linear-gradient(90deg,#facc15 0%,#ef4444 100%); }
    body.dark-mode .mobile-search-result { background: rgba(24,28,42,0.96); color: #e7e7ef; }
    body.dark-mode .mobile-search-result:hover { background: rgba(99,102,241,0.13); }
    body.dark-mode .leaflet-popup-content { color: #e7e7ef; }
    body.dark-mode .panel header { color: #a5b4fc; }
    body.dark-mode .hint { color: #a5b4fc; }
    body.dark-mode #userEmail { color: #a5b4fc; }

    /* Accessibility: focus style for buttons and inputs */
    button:focus, .icon-btn:focus, .btn:focus, input:focus, textarea:focus, select:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Hide mobile-only by default, show on mobile */
    .mobile-only { display: none !important; }
    @media (max-width: 600px) {
      .mobile-only { display: inline-flex !important; }
      .search-wrap input,
      .search-wrap button#searchBtn { display: none !important; }
    }

    /* Mobile search overlay */
    .mobile-search-overlay {
      display: none;
      position: fixed;
      z-index: 3000;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      background: rgba(24,28,42,0.92);
      backdrop-filter: blur(8px);
      align-items: flex-start;
      justify-content: center;
      flex-direction: column;
      padding: 0;
    }
    .mobile-search-overlay.active {
      display: flex;
    }
    .mobile-search-bar {
      width: 100vw;
      display: flex;
      align-items: center;
      padding: 18px 12px 10px 12px;
      background: rgba(36,40,56,0.98);
      box-sizing: border-box;
      gap: 10px;
    }
    #mobileSearchInput {
      flex: 1;
      font-size: 18px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1.5px solid #e0e7ef;
      background: #fff;
      color: #23272f;
      outline: none;
      box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    }
    body.dark-mode #mobileSearchInput {
      background: #232946;
      color: #e7e7ef;
      border-color: #2d334d;
    }
    #mobileSearchClose {
      background: transparent;
      border: none;
      padding: 8px;
      border-radius: 10px;
      min-width: 44px;
      min-height: 44px;
    }
    #mobileSearchClose img { width: 28px; height: 28px; }

    #mobileSearchResults {
      width: 100vw;
      max-height: 60vh;
      overflow-y: auto;
      background: rgba(255,255,255,0.97);
      border-radius: 0 0 18px 18px;
      box-shadow: 0 8px 32px rgba(37,99,235,0.13);
      margin-top: 0;
      padding: 0;
    }
    body.dark-mode #mobileSearchResults {
      background: rgba(24,28,42,0.96);
      color: #e7e7ef;
    }
    .mobile-search-result {
      padding: 16px 18px;
      border-bottom: 1px solid #e0e7ef;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .mobile-search-result:last-child { border-bottom: none; }
    .mobile-search-result:hover {
      background: rgba(37,99,235,0.08);
    }

    /* Smaller, more transparent add panel */
    .panel {
      width: 320px;
      max-width: 92vw;
      left: auto;
      right: 2vw;
      top: 80px;
      background: rgba(255,255,255,0.65);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(37,99,235,0.10);
      opacity: 0.98;
      z-index: 2100;
      padding: 0;
      display: none;
      backdrop-filter: blur(10px);
      pointer-events: auto;
      transition: background 0.18s, width 0.18s, right 0.18s;
    }
    .panel header {
      font-size: 15px;
      padding: 10px 14px 6px 14px;
      background: transparent;
      border-bottom: 1px solid #e0e7ef;
      color: var(--accent);
      font-weight: 700;
      letter-spacing: -.2px;
    }
    .content {
      padding: 10px 14px 14px 14px;
      gap: 8px;
      background: transparent;
    }
    @media (max-width: 600px) {
      .panel {
        width: 96vw;
        max-width: 98vw;
        right: 2vw;
        left: auto;
        top: 56px;
        border-radius: 14px;
        background: rgba(255,255,255,0.60);
        opacity: 0.97;
        box-shadow: 0 2px 12px rgba(37,99,235,0.08);
        padding: 0;
      }
      .panel header { font-size: 14px; padding: 8px 10px 6px 10px; }
      .content { padding: 8px 10px 10px 10px; gap: 7px; }
    }

    /* Always show legend, remove legend-toggle button */
    .legend .legend-toggle {
      display: none !important;
    }

    /* --- Mobile UI improvements --- */
    @media (max-width: 600px) {
      header {
        height: 44px !important;
        min-height: 44px !important;
        padding: 2px 2vw !important;
        gap: 4px !important;
      }
      header h1 {
        font-size: 15px !important;
        margin-right: 4px !important;
      }
      .search-wrap {
        padding: 0 2px !important;
        gap: 2px !important;
        min-width: 0 !important;
        max-width: 100vw !important;
        background: rgba(255,255,255,0.65) !important;
        box-shadow: none !important;
      }
      #searchInput {
        font-size: 14px !important;
        padding: 7px 6px !important;
        border-radius: 8px !important;
        min-width: 0 !important;
        width: 100% !important;
      }
      #searchBtn {
        font-size: 14px !important;
        padding: 7px 10px !important;
        border-radius: 8px !important;
      }
      .icon-btn, .btn {
        min-width: 36px !important;
        min-height: 36px !important;
        font-size: 14px !important;
        padding: 6px 6px !important;
        border-radius: 8px !important;
        margin: 0 1px !important;
      }
      .icon-btn img { width: 18px !important; height: 18px !important; }
      #addLabel, #userEmail, .hint {
        display: none !important;
      }
      #filterBox {
        top: 44px !important;
        right: 2vw !important;
        min-width: 0 !important;
        max-width: 92vw !important;
        width: auto !important;
        font-size: 13px !important;
        z-index: 2200 !important;
      }
      #filterBox:not(.collapsed) {
        width: 92vw !important;
        min-width: 0 !important;
        max-width: 98vw !important;
        padding: 8px 6px !important;
      }
      #filterBox.collapsed {
        padding: 6px 8px !important;
        height: 34px !important;
      }
      #filterHeader {
        margin-bottom: 4px !important;
      }
      #filterBody label {
        font-size: 13px !important;
        gap: 4px !important;
        padding: 2px 0 !important;
      }
      #filterBody label input[type=checkbox] {
        width: 16px !important;
        height: 16px !important;
        margin: 0 4px 0 0 !important;
      }
      .panel {
        width: 98vw !important;
        max-width: 99vw !important;
        right: 1vw !important;
        left: auto !important;
        top: 44px !important;
        border-radius: 10px !important;
        background: rgba(255,255,255,0.60) !important;
        opacity: 0.97 !important;
        box-shadow: 0 1px 6px rgba(37,99,235,0.08) !important;
        padding: 0 !important;
      }
      .panel header { font-size: 13px !important; padding: 6px 8px 4px 8px !important; }
      .content { padding: 6px 8px 8px 8px !important; gap: 5px !important; }
      .legend {
        width: 96vw !important;
        right: 2vw !important;
        bottom: 8px !important;
        padding: 6px 6px !important;
        font-size: 11px !important;
        max-width: 98vw !important;
      }
      .legend .bar { height: 8px !important; }
      .credit {
        right: 2vw !important;
        bottom: 56px !important;
        font-size: 11px !important;
        padding: 4px 8px !important;
      }
    }

    /* Hide user email and add label on mobile always */
    @media (max-width: 600px) {
      #userEmail, #addLabel, .hint { display: none !important; }
    }

    /* --- Mobile search overlay improvements --- */
    .mobile-search-overlay {
      background: rgba(24,28,42,0.82) !important;
      backdrop-filter: blur(10px) !important;
      z-index: 3000 !important;
      align-items: flex-start !important;
      justify-content: flex-start !important;
      padding-top: 0 !important;
    }
    .mobile-search-bar {
      width: 100vw !important;
      display: flex !important;
      align-items: center !important;
      padding: 10px 6px 6px 6px !important;
      background: rgba(36,40,56,0.85) !important;
      box-sizing: border-box !important;
      gap: 6px !important;
      border-radius: 0 0 12px 12px !important;
    }
    #mobileSearchInput {
      flex: 1 !important;
      font-size: 16px !important;
      padding: 8px 10px !important;
      border-radius: 8px !important;
      border: 1.5px solid #e0e7ef !important;
      background: rgba(255,255,255,0.85) !important;
      color: #23272f !important;
      outline: none !important;
      box-shadow: 0 1px 4px rgba(37,99,235,0.06) !important;
    }
    body.dark-mode #mobileSearchInput {
      background: rgba(35,41,70,0.95) !important;
      color: #e7e7ef !important;
      border-color: #2d334d !important;
    }
    #mobileSearchClose {
      background: transparent !important;
      border: none !important;
      padding: 6px !important;
      border-radius: 8px !important;
      min-width: 36px !important;
      min-height: 36px !important;
    }
    #mobileSearchClose img { width: 22px !important; height: 22px !important; }
    #mobileSearchResults {
      width: 100vw !important;
      max-height: 60vh !important;
      overflow-y: auto !important;
      background: rgba(255,255,255,0.97) !important;
      border-radius: 0 0 12px 12px !important;
      box-shadow: 0 2px 8px rgba(37,99,235,0.10) !important;
      margin-top: 0 !important;
      padding: 0 !important;
    }
    body.dark-mode #mobileSearchResults {
      background: rgba(24,28,42,0.96) !important;
      color: #e7e7ef !important;
    }
    .mobile-search-result {
      padding: 10px 12px !important;
      border-bottom: 1px solid #e0e7ef !important;
      font-size: 15px !important;
      cursor: pointer !important;
      transition: background 0.18s !important;
    }
    .mobile-search-result:last-child { border-bottom: none !important; }
    .mobile-search-result:hover {
      background: rgba(37,99,235,0.08) !important;
    }

    /* Hide desktop search bar input and button on mobile */
    @media (max-width: 600px) {
      .search-wrap input,
      .search-wrap button#searchBtn {
        display: none !important;
      }
    }

    /* Ensure z-index for overlays and panels */
    #filterBox, .panel, .legend, .credit, .mobile-search-overlay {
      z-index: 3000 !important;
    }

    /* Hide Leaflet zoom controls on mobile (completely, including all children) */
    @media (max-width: 600px) {
      .leaflet-control-zoom,
      .leaflet-control-zoom * {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
        height: 0 !important;
        width: 0 !important;
        min-width: 0 !important;
        min-height: 0 !important;
      }
    }

    /* Make Leaflet popups smaller and more compact on mobile */
    @media (max-width: 600px) {
      .leaflet-popup-content-wrapper {
        min-width: 0 !important;
        max-width: 92vw !important;
        padding: 0 !important;
        border-radius: 10px !important;
        font-size: 13px !important;
      }
      .leaflet-popup-content {
        font-size: 13px !important;
        padding: 8px 6px 6px 6px !important;
        min-width: 0 !important;
        max-width: 92vw !important;
        word-break: break-all !important;
        overflow-wrap: break-word !important;
        line-height: 1.25 !important;
      }
      .popup > div,
      .popup .badge,
      .popup button,
      .popup .btn-ghost,
      .popup .vote-btn {
        font-size: 12px !important;
        padding: 4px 7px !important;
        margin: 0 1px !important;
        border-radius: 7px !important;
        line-height: 1.2 !important;
      }
      .popup {
        padding: 0 !important;
        margin: 0 !important;
      }
      .popup > div {
        margin: 0 0 2px 0 !important;
        padding: 0 !important;
      }
      .popup .badge {
        padding: 1px 6px !important;
        font-size: 11px !important;
        margin-left: 3px !important;
      }
      .popup .btn-ghost, .popup .vote-btn {
        min-width: 0 !important;
        min-height: 0 !important;
        font-size: 12px !important;
        padding: 4px 7px !important;
      }
    }
    .leaflet-control-locate {
      margin-top: 12px !important;
    }
    .leaflet-control-zoom {
      margin-top: 64px !important;
    }
    .leaflet-control-zoom-in, .leaflet-control-zoom-out {
      min-width: 44px;
      min-height: 44px;
      font-size: 20px;
    }

    /* 9. Marker cluster - smaller icons for mobile */
    @media (max-width: 600px) {
      .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
        width: 32px !important;
        height: 32px !important;
        font-size: 13px !important;
      }
    }

    /* 10. General mobile UX improvements */
    @media (max-width: 900px) {
      header { height: 52px; min-height: 52px; }
      #filterBox { top: 56px; }
      .panel { top: 56px; }
    }
    @media (max-width: 600px) {
      header { height: 48px; min-height: 48px; padding: 4px 2vw; }
      #filterBox { top: 48px; }
      .panel { top: 48px; }
      #searchResults { top: 48px; }
    }
    @media (max-width: 400px) {
      header { padding: 2px 1vw; }
      .panel { left: 1vw; width: 98vw; }
      #filterBox { right: 1vw; width: 98vw; }
      .legend { right: 1vw; width: 98vw; }
      .credit { right: 1vw; }
    }

    /* 11. Touch-friendly design */
    button, .icon-btn, .btn, .vote-btn {
      touch-action: manipulation;
    }

    /* 12. Hide scrollbars on mobile for map */
    body, html {
      overflow: hidden;
    }

    body.dark-mode{
      background:linear-gradient(120deg,#232946 0%,#181c2a 100%);
      color:#e5e7ef;
    }
    body.dark-mode header,
    body.dark-mode .panel,
    body.dark-mode #filterBox,
    body.dark-mode .legend,
    body.dark-mode .search-wrap,
    body.dark-mode #searchResults,
    body.dark-mode .leaflet-popup-content-wrapper,
    body.dark-mode .mobile-search-bar,
    body.dark-mode #mobileSearchResults,
    body.dark-mode .credit {
      background:rgba(24,28,42,0.96) !important;
      color:#e5e7ef !important;
      border-color:#2d334d !important;
      box-shadow:0 8px 32px rgba(37,99,235,0.13);
    }
    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select,
    body.dark-mode #mobileSearchInput {
      background: #232946 !important;
      color: #e5e7ef !important;
      border-color: #2d334d !important;
    }
    body.dark-mode .btn-primary {
      background: linear-gradient(90deg,#3b82f6 0%,#6366f1 100%);
      color: #fff;
    }
    body.dark-mode .btn-secondary { background: #374151; }
    body.dark-mode .btn-ghost { background: rgba(99,102,241,0.10); }
    body.dark-mode .vote-btn { background: #232946; color: #e7e7ef; border-color: #2d334d; }
    body.dark-mode .vote-btn.upvoted { background: var(--success); }
    body.dark-mode .vote-btn.downvoted { background: var(--danger); }
    body.dark-mode .legend .bar { background: linear-gradient(90deg,#facc15 0%,#ef4444 100%); }
    body.dark-mode .mobile-search-result { background: rgba(24,28,42,0.96); color: #e7e7ef; }
    body.dark-mode .mobile-search-result:hover { background: rgba(99,102,241,0.13); }
    body.dark-mode .leaflet-popup-content { color: #e7e7ef; }
    body.dark-mode .panel header { color: #a5b4fc; }
    body.dark-mode .hint { color: #a5b4fc; }
    body.dark-mode #userEmail { color: #a5b4fc; }

    /* Accessibility: focus style for buttons and inputs */
    button:focus, .icon-btn:focus, .btn:focus, input:focus, textarea:focus, select:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Hide mobile-only by default, show on mobile */
    .mobile-only { display: none !important; }
    @media (max-width: 600px) {
      .mobile-only { display: inline-flex !important; }
      .search-wrap input,
      .search-wrap button#searchBtn { display: none !important; }
    }

    /* Mobile search overlay */
    .mobile-search-overlay {
      display: none;
      position: fixed;
      z-index: 3000;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      background: rgba(24,28,42,0.92);
      backdrop-filter: blur(8px);
      align-items: flex-start;
      justify-content: center;
      flex-direction: column;
      padding: 0;
    }
    .mobile-search-overlay.active {
      display: flex;
    }
    .mobile-search-bar {
      width: 100vw;
      display: flex;
      align-items: center;
      padding: 18px 12px 10px 12px;
      background: rgba(36,40,56,0.98);
      box-sizing: border-box;
      gap: 10px;
    }
    #mobileSearchInput {
      flex: 1;
      font-size: 18px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1.5px solid #e0e7ef;
      background: #fff;
      color: #23272f;
      outline: none;
      box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    }
    body.dark-mode #mobileSearchInput {
      background: #232946;
      color: #e7e7ef;
      border-color: #2d334d;
    }
    #mobileSearchClose {
      background: transparent;
      border: none;
      padding: 8px;
      border-radius: 10px;
      min-width: 44px;
      min-height: 44px;
    }
    #mobileSearchClose img { width: 28px; height: 28px; }

    #mobileSearchResults {
      width: 100vw;
      max-height: 60vh;
      overflow-y: auto;
      background: rgba(255,255,255,0.97);
      border-radius: 0 0 18px 18px;
      box-shadow: 0 8px 32px rgba(37,99,235,0.13);
      margin-top: 0;
      padding: 0;
    }
    body.dark-mode #mobileSearchResults {
      background: rgba(24,28,42,0.96);
      color: #e7e7ef;
    }
    .mobile-search-result {
      padding: 16px 18px;
      border-bottom: 1px solid #e0e7ef;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .mobile-search-result:last-child { border-bottom: none; }
    .mobile-search-result:hover {
      background: rgba(37,99,235,0.08);
    }

    /* Smaller, more transparent add panel */
    .panel {
      width: 320px;
      max-width: 92vw;
      left: auto;
      right: 2vw;
      top: 80px;
      background: rgba(255,255,255,0.65);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(37,99,235,0.10);
      opacity: 0.98;
      z-index: 2100;
      padding: 0;
      display: none;
      backdrop-filter: blur(10px);
      pointer-events: auto;
      transition: background 0.18s, width 0.18s, right 0.18s;
    }
    .panel header {
      font-size: 15px;
      padding: 10px 14px 6px 14px;
      background: transparent;
      border-bottom: 1px solid #e0e7ef;
      color: var(--accent);
      font-weight: 700;
      letter-spacing: -.2px;
    }
    .content {
      padding: 10px 14px 14px 14px;
      gap: 8px;
      background: transparent;
    }
    @media (max-width: 600px) {
      .panel {
        width: 96vw;
        max-width: 98vw;
        right: 2vw;
        left: auto;
        top: 56px;
        border-radius: 14px;
        background: rgba(255,255,255,0.60);
        opacity: 0.97;
        box-shadow: 0 2px 12px rgba(37,99,235,0.08);
        padding: 0;
      }
      .panel header { font-size: 14px; padding: 8px 10px 6px 10px; }
      .content { padding: 8px 10px 10px 10px; gap: 7px; }
    }

    /* Always show legend, remove legend-toggle button */
    .legend .legend-toggle {
      display: none !important;
    }

    /* --- Mobile UI improvements --- */
    @media (max-width: 600px) {
      header {
        height: 44px !important;
        min-height: 44px !important;
        padding: 2px 2vw !important;
        gap: 4px !important;
      }
      header h1 {
        font-size: 15px !important;
        margin-right: 4px !important;
      }
      .search-wrap {
        padding: 0 2px !important;
        gap: 2px !important;
        min-width: 0 !important;
        max-width: 100vw !important;
        background: rgba(255,255,255,0.65) !important;
        box-shadow: none !important;
      }
      #searchInput {
        font-size: 14px !important;
        padding: 7px 6px !important;
        border-radius: 8px !important;
        min-width: 0 !important;
        width: 100% !important;
      }
      #searchBtn {
        font-size: 14px !important;
        padding: 7px 10px !important;
        border-radius: 8px !important;
      }
      .icon-btn, .btn {
        min-width: 36px !important;
        min-height: 36px !important;
        font-size: 14px !important;
        padding: 6px 6px !important;
        border-radius: 8px !important;
        margin: 0 1px !important;
      }
      .icon-btn img { width: 18px !important; height: 18px !important; }
      #addLabel, #userEmail, .hint {
        display: none !important;
      }
      #filterBox {
        top: 44px !important;
        right: 2vw !important;
        min-width: 0 !important;
        max-width: 92vw !important;
        width: auto !important;
        font-size: 13px !important;
        z-index: 2200 !important;
      }
      #filterBox:not(.collapsed) {
        width: 92vw !important;
        min-width: 0 !important;
        max-width: 98vw !important;
        padding: 8px 6px !important;
      }
      #filterBox.collapsed {
        padding: 6px 8px !important;
        height: 34px !important;
      }
      #filterHeader {
        margin-bottom: 4px !important;
      }
      #filterBody label {
        font-size: 13px !important;
        gap: 4px !important;
        padding: 2px 0 !important;
      }
      #filterBody label input[type=checkbox] {
        width: 16px !important;
        height: 16px !important;
        margin: 0 4px 0 0 !important;
      }
      .panel {
        width: 98vw !important;
        max-width: 99vw !important;
        right: 1vw !important;
        left: auto !important;
        top: 44px !important;
        border-radius: 10px !important;
        background: rgba(255,255,255,0.60) !important;
        opacity: 0.97 !important;
        box-shadow: 0 1px 6px rgba(37,99,235,0.08) !important;
        padding: 0 !important;
      }
      .panel header { font-size: 13px !important; padding: 6px 8px 4px 8px !important; }
      .content { padding: 6px 8px 8px 8px !important; gap: 5px !important; }
      .legend {
        width: 96vw !important;
        right: 2vw !important;
        bottom: 8px !important;
        padding: 6px 6px !important;
        font-size: 11px !important;
        max-width: 98vw !important;
      }
      .legend .bar { height: 8px !important; }
      .credit {
        right: 2vw !important;
        bottom: 56px !important;
        font-size: 11px !important;
        padding: 4px 8px !important;
      }
    }

    /* Hide user email and add label on mobile always */
    @media (max-width: 600px) {
      #userEmail, #addLabel, .hint { display: none !important; }
    }

    /* --- Mobile search overlay improvements --- */
    .mobile-search-overlay {
      background: rgba(24,28,42,0.82) !important;
      backdrop-filter: blur(10px) !important;
      z-index: 3000 !important;
      align-items: flex-start !important;
      justify-content: flex-start !important;
      padding-top: 0 !important;
    }
    .mobile-search-bar {
      width: 100vw !important;
      display: flex !important;
      align-items: center !important;
      padding: 10px 6px 6px 6px !important;
      background: rgba(36,40,56,0.85) !important;
      box-sizing: border-box !important;
      gap: 6px !important;
      border-radius: 0 0 12px 12px !important;
    }
    #mobileSearchInput {
      flex: 1 !important;
      font-size: 16px !important;
      padding: 8px 10px !important;
      border-radius: 8px !important;
      border: 1.5px solid #e0e7ef !important;
      background: rgba(255,255,255,0.85) !important;
      color: #23272f !important;
      outline: none !important;
      box-shadow: 0 1px 4px rgba(37,99,235,0.06) !important;
    }
    body.dark-mode #mobileSearchInput {
      background: rgba(35,41,70,0.95) !important;
      color: #e7e7ef !important;
      border-color: #2d334d !important;
    }
    #mobileSearchClose {
      background: transparent !important;
      border: none !important;
      padding: 6px !important;
      border-radius: 8px !important;
      min-width: 36px !important;
      min-height: 36px !important;
    }
    #mobileSearchClose img { width: 22px !important; height: 22px !important; }
    #mobileSearchResults {
      width: 100vw !important;
      max-height: 60vh !important;
      overflow-y: auto !important;
      background: rgba(255,255,255,0.97) !important;
      border-radius: 0 0 12px 12px !important;
      box-shadow: 0 2px 8px rgba(37,99,235,0.10) !important;
      margin-top: 0 !important;
      padding: 0 !important;
    }
    body.dark-mode #mobileSearchResults {
      background: rgba(24,28,42,0.96) !important;
      color: #e7e7ef !important;
    }
    .mobile-search-result {
      padding: 10px 12px !important;
      border-bottom: 1px solid #e0e7ef !important;
      font-size: 15px !important;
      cursor: pointer !important;
      transition: background 0.18s !important;
    }
    .mobile-search-result:last-child { border-bottom: none !important; }
    .mobile-search-result:hover {
      background: rgba(37,99,235,0.08) !important;
    }

    /* Hide desktop search bar input and button on mobile */
    @media (max-width: 600px) {
      .search-wrap input,
      .search-wrap button#searchBtn {
        display: none !important;
      }

    }

    /* Ensure z-index for overlays and panels */
    #filterBox, .panel, .legend, .credit, .mobile-search-overlay {
      z-index: 3000 !important;
    }
